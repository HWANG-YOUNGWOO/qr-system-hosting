**작성 계획**

우리는 제목, 목적/배경/프로세스/체크포인트/주의사항 섹션이 있는 마크다운 문서를 작성해야 해요. 여기서 다룰 명령어들은 git status, branch show current, 특정 파일 추가, commit 메시지, push origin HEAD, config user, gh pr view --web, gh run list/view with run-id와 같은 것들이죠. 또한, Actions 로그 탐색도 포함해야 해요. 문서 형식은 문장으로 된 제목과, 본문은 굵은 글씨로 핵심 항목을 강조하는 방식이어야 해요.

# 안전한 PR 중심 배포 파이프라인 운영 가이드

당신이 지금 밟고 있는 흐름은 “변경을 안전하고 투명하게 메인(main)에 반영하기 위한 협업 파이프라인”을 구축·운영하는 과정입니다. 기능 개발이나 워크플로우 수정이 단순히 코드 추가로 끝나는 게 아니라, 자동 검사(CI), 가시성(봇 코멘트), 재현 가능성(캐싱·버전 고정), 승인(리뷰/PR)까지 한 사이클로 이어지도록 만드는 게 핵심 목적입니다.
협업 환경에서 변경을 안정적으로 main에 반영하기 위한 전체 흐름을 목적/배경부터 구체 명령어, 체크포인트, 주의사항까지 단계별로 정리한 문서입니다. 단순히 코드를 푸시하는 것을 넘어, CI 체크와 봇 코멘트로 가시성을 확보하고, 로그 기반으로 문제를 빠르게 진단·수정하는 체계를 갖추는 것이 목표입니다.

---

## 목적과 배경

- **목표:** 작업 브랜치에서 변경을 커밋·푸시하고, PR을 통해 자동 체크(CI)를 거쳐 main에 안전하게 반영한다.
- **왜 필요한가:**  
  - **품질 보증:** 자동화된 CI가 빌드/테스트/검증을 수행해 실수를 사전에 걸러낸다.  
  - **가시성 확보:** 봇 코멘트와 PR Checks로 결과가 대화(Conversation)에 남아 팀이 한눈에 파악한다.  
  - **재현 가능성/속도:** 캐시와 표준 액션(@actions/*)을 사용해 실행 환경을 안정화하고 실행 속도를 높인다.  
  - **메인 보호:** 직접 main에 커밋하지 않고, 브랜치→PR→리뷰/체크→머지의 게이트로 신뢰도를 유지한다.  
  - **추적성:** 커밋/PR/Actions 로그로 “무엇을, 왜, 어떻게” 변경했는지 기록이 남는다.

## 왜 필요한가

- 품질 보증: PR가 열릴 때마다 CI가 자동으로 실행되어 빌드/테스트/스크립트가 정상 동작하는지 확인합니다. 사람의 실수를 시스템으로 보완하는 구조입니다.
- 가시성 확보: 봇 코멘트나 업데이트를 통해 결과(예: 스크린샷 체크, 배포 상태)를 PR 대화(Conversation) 안에 남깁니다. 누구나 현재 상태를 한눈에 파악합니다.
- 재현 가능성/속도: setup-node와 cache-dependency-path 같은 캐시 설정으로, 각 실행이 동일한 환경에서 빨리 동작합니다. CI가 빠르고 안정적으로 돌아야 팀 전체 속도가 유지됩니다.
- 안전한 반영: 바로 main에 밀어 넣지 않고, 작업 브랜치 → PR → 리뷰·체크 → 머지로 진행합니다. 문제가 생기면 PR에서 드러나고 차단되기에, main의 신뢰도가 유지됩니다.
- 추적성과 책임: 모든 변경은 커밋 메시지, PR, Actions 로그, 봇 코멘트로 기록됩니다. 무엇이, 왜, 언제, 누가 바꿨는지 흔적이 남아 회고와 장애 분석이 쉬워집니다.

## 무엇을 하고 있나

- 작업 브랜치에서 변경: fix/pr-screenshot-check에서 워크플로우와 스크립트를 수정하고 커밋/푸시합니다. main을 더럽히지 않고 안전하게 실험·개선합니다.
- PR 생성과 연결: --base main --head fix/...로 PR을 만들고, 모든 변경을 리뷰와 체크 아래에 둡니다.
- CI 파이프라인 실행: PR 이벤트로 CI/CD, 배포, 스크린샷 검증 등의 워크플로우가 자동 실행됩니다. 실패/성공이 명확히 드러납니다.
- 봇 커멘트로 피드백 노출: 스크립트가 결과를 코멘트로 남기거나 업데이트하여, 팀이 PR 화면만으로 품질 신호를 확인합니다.
- Actions 로그 확인: gh run list/view와 PR의 Checks/Actions 탭에서 어떤 단계가 왜 실패했는지 근거를 확인하고 수정합니다.

## 이 과정의 핵심 요소

- PR 중심 개발: 메인 보호를 위해 브랜치 전략과 리뷰 문화를 강제합니다.
- 워크플로우 안정화: @actions/* 사용, 스크립트 개선, 캐시 설정으로 환경 흔들림을 줄입니다.
- 명확한 커밋 메시지: “무엇을 왜 바꿨는지”가 메시지에서 드러나야 CI 실패 시 빠르게 역추적 가능합니다.
- 런 로그로 문제 해결: 실패의 실제 원인(환경, 권한, 네트워크, 스크립트 버그)을 로그에서 찾고, 최소 변경으로 재시도합니다.

---

## 단계별 과정과 명령어

### 브랜치와 변경사항 확인

- **현재 변경 확인:**
  ```
  git status --porcelain
  ```
- **현재 브랜치 확인:**
  ```
  git branch --show-current
  ```

### 변경 스테이징·커밋·푸시

- **선택적 스테이징:** 의도한 파일만 포함해 커밋 범위를 명확히 한다.
  ```
  git add .github/workflows/ci-cd.yml
  ```
- **의미 있는 커밋 메시지로 커밋:**
  ```
  git commit -m "ci: add cache-dependency-path for setup-node (functions/web package-lock.json)"
  ```
- **현재 브랜치로 푸시:**
  ```
  git push origin HEAD
  ```
  > 참고: 최초 푸시라면 추적 설정을 위해 `git push -u origin <현재브랜치명>` 사용.

- **커밋 author 오류 시 설정:**
  ```
  git config --global user.email "ywhwang21@gmail.com"
  git config --global user.name "HWANG-YOUNGWOO"
  ```
  > 저장소 한정 설정을 원하면 `--local`로 대체.

### PR 확인 및 웹 페이지 열기

- **현재 브랜치의 PR 상세 웹 페이지 열기:**
  ```
  gh pr view --web
  ```

### Actions 실행 목록과 상세 로그 확인

- **최근 실행 5개 확인:**
  ```
  gh run list --limit 5
  ```
- **특정 실행 로그 보기(run-id는 목록에서 확인한 숫자):**
  ```
  gh run view <run-id> --log
  ```

### PR 페이지에서 Checks와 봇 코멘트 확인

- **Checks 확인 경로:** 저장소 → Pull requests → 해당 PR(#2) → 상단 Checks 요약 → 개별 워크플로우의 Details 클릭.  
- **Actions 탭 경로:** 저장소 → Actions → 워크플로우 선택 → 실행 건 선택 → Job 클릭 → 단계별(step) 로그 확인.  
- **봇 코멘트 위치:** PR 페이지 → Conversation 탭에서 코멘트 생성/업데이트 확인.

---

### 성공 기준과 체크포인트

- PR Checks 전부 통과: CI/CD, 배포, 스크린샷 검증 등 정의된 모든 워크플로우가 초록불.
- 봇 코멘트 생성/업데이트: Conversation 탭에 자동 피드백이 보이고, 변경 시 자동 업데이트됩니다.
- main 무사 반영: 리뷰 승인 후 전략(merge/squash/rebase)에 맞게 머지, main의 안정성 유지.
- 로그 투명성: 실패 시 누구나 Actions 로그와 코멘트만으로 원인을 재현·수정 가능.

## 체크포인트

- **브랜치 확인:**  
  - **현재 브랜치:** `git branch --show-current`로 확인한다.  
  - **메인 보호:** main에서 직접 커밋하지 말고 작업 브랜치에서 진행 후 PR로 반영한다.
- **스테이징 범위:**  
  - **의도 일치:** `git add`에 포함된 파일이 목적과 일치하는지 재확인한다.  
  - **누락 방지:** CI에 필요한 파일이 빠지지 않았는지 체크한다.
- **PR 상태:**  
  - **Checks 진행:** PR 상단에 Checks가 표시되는지 확인한다.  
  - **결과 반영:** 성공 시 봇 코멘트(또는 업데이트)가 Conversation에 나타나는지 확인한다.
- **Actions 상태:**  
  - **최근 실행:** `gh run list --limit 5`에서 상태 아이콘 확인(✓ 성공, X 실패).  
  - **실패 원인:** `gh run view <run-id> --log`로 마지막 에러 메시지를 우선 확인한다.
- **main 동기화:**  
  - **불일치 해결:** push 거부 시 `git checkout main && git pull origin main`으로 원격과 동기화한다.

---

## 주의사항1

- 브랜치 혼동 금지: 현재 브랜치가 main이 아닌 인지 확인하고, main에는 PR을 통해서만 반영하세요.
- 부분 스테이징의 의도 확인: 로 특정 파일만 올릴 때, 누락으로 CI가 실패하지 않도록 변경 범위를 의식적으로 관리하세요.
- 전역 설정 영향: 은 PC 전체 사용자 환경에 적용됩니다. 저장소 한정이면 을 사용하세요.
- 비밀 관리: 토큰/시크릿은 코드에 두지 말고 GitHub Secrets와 권한 범위를 사용하세요.

## 주의사항2

- **현재 브랜치 오작업 방지:**  
  - **리스크:** main에서 직접 커밋/푸시하면 바로 기준 브랜치가 변경된다.  
  - **대응:** 작업 브랜치(`fix/...`)에서 커밋 → PR로 반영하는 흐름을 유지.
- **부분 스테이징 시나리오:**  
  - **리스크:** 의존 파일 누락으로 CI 실패 가능.  
  - **대응:** 변경 목적에 필요한 파일 세트를 함께 스테이징한다.
- **커밋 메시지 품질:**  
  - **리스크:** 모호한 메시지는 문제 발생 시 역추적을 어렵게 한다.  
  - **대응:** “무엇/왜”가 드러나게 작성한다(예: ci: cache-dependency-path 추가로 setup-node 캐시 안정화).
- **전역 설정 영향:**  
  - **리스크:** `--global`은 PC 사용자 환경 전체에 적용된다.  
  - **대응:** 저장소 한정이면 `git config --local` 사용.
- **비밀 관리:**  
  - **리스크:** 토큰/키를 코드에 커밋하면 보안 사고로 이어진다.  
  - **대응:** GitHub Secrets와 최소 권한 범위를 사용.
- **run-id 정확성:**  
  - **리스크:** 임의 값 사용 시 로그 조회 실패.  
  - **대응:** 반드시 `gh run list`의 ID 열 숫자를 사용한다.

---

## 빠른 실행 예시 시나리오

- **변경 확인:**
  ```
  git status --porcelain
  git branch --show-current
  ```
- **스테이징/커밋/푸시:**
  ```
  git add .github/workflows/ci-cd.yml
  git commit -m "ci: add cache-dependency-path for setup-node (functions/web package-lock.json)"
  git push origin HEAD
  ```
- **PR 확인:**
  ```
  gh pr view --web
  ```
- **Actions 확인:**
  ```
  gh run list --limit 5
  gh run view <run-id> --log
  ```

이 문서의 과정을 따르면, 변경은 투명하게 기록되고 자동 검사로 검증되며, 문제는 로그를 근거로 빠르게 수정되어 신뢰할 수 있는 main을 유지할 수 있습니다.